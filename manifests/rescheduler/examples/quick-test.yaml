# ğŸ§ª é‡è°ƒåº¦å™¨å¿«é€Ÿæµ‹è¯•é…ç½®
# ç”¨äºéªŒè¯é‡è°ƒåº¦å™¨åŸºæœ¬åŠŸèƒ½çš„æµ‹è¯•å·¥ä½œè´Ÿè½½
# éƒ¨ç½²å‘½ä»¤: kubectl apply -f manifests/rescheduler/examples/quick-test.yaml

---
# æµ‹è¯•å‘½åç©ºé—´
apiVersion: v1
kind: Namespace
metadata:
  name: rescheduler-test
  labels:
    app: rescheduler-test
    purpose: testing

---
# ğŸ¯ æµ‹è¯•1ï¼šè´Ÿè½½å‡è¡¡éªŒè¯
# åˆ›å»ºå¤šä¸ªPodæµ‹è¯•è´Ÿè½½å‡è¡¡é‡è°ƒåº¦
apiVersion: apps/v1
kind: Deployment
metadata:
  name: load-balance-test
  namespace: rescheduler-test
  labels:
    app: load-balance-test
    test-type: load-balancing
spec:
  replicas: 12  # è¶³å¤Ÿçš„å‰¯æœ¬æ•°é‡è§¦å‘è´Ÿè½½å‡è¡¡
  selector:
    matchLabels:
      app: load-balance-test
  template:
    metadata:
      labels:
        app: load-balance-test
        test-type: load-balancing
    spec:
      schedulerName: rescheduler-scheduler  # ä½¿ç”¨é‡è°ƒåº¦å™¨
      containers:
      - name: nginx
        image: nginx:alpine
        resources:
          requests:
            cpu: 50m      # è½»é‡çº§èµ„æºè¯·æ±‚
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi
        ports:
        - containerPort: 80
        # æ·»åŠ å°±ç»ªæ¢é’ˆç¡®ä¿PodçŠ¶æ€
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
      restartPolicy: Always

---
# ğŸ”¥ æµ‹è¯•2ï¼šèµ„æºå‹åŠ›æµ‹è¯•
# åˆ›å»ºé«˜èµ„æºä½¿ç”¨çš„Podæµ‹è¯•èµ„æºä¼˜åŒ–é‡è°ƒåº¦
apiVersion: v1
kind: Pod
metadata:
  name: resource-stress-test
  namespace: rescheduler-test
  labels:
    app: resource-stress
    test-type: resource-optimization
spec:
  schedulerName: rescheduler-scheduler
  containers:
  - name: stress-cpu
    image: progrium/stress
    args: 
    - --cpu
    - "1"           # 1ä¸ªCPUæ ¸å¿ƒå‹åŠ›
    - --vm
    - "1"           # 1ä¸ªå†…å­˜å‹åŠ›è¿›ç¨‹
    - --vm-bytes
    - "256M"        # 256MBå†…å­˜å‹åŠ›
    - --timeout
    - "300s"        # 5åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢
    resources:
      requests:
        cpu: 800m     # é«˜CPUè¯·æ±‚
        memory: 400Mi # é«˜å†…å­˜è¯·æ±‚
      limits:
        cpu: 1000m
        memory: 512Mi
  restartPolicy: Never

---
# ğŸ”„ æµ‹è¯•3ï¼šæ»šåŠ¨éƒ¨ç½²æµ‹è¯•
# æµ‹è¯•æ»šåŠ¨æ›´æ–°æœŸé—´çš„é‡è°ƒåº¦è¡Œä¸º
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rolling-update-test
  namespace: rescheduler-test
  labels:
    app: rolling-update-test
    test-type: rolling-update
spec:
  replicas: 6
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: rolling-update-test
  template:
    metadata:
      labels:
        app: rolling-update-test
        test-type: rolling-update
        version: "v1"  # ç‰ˆæœ¬æ ‡ç­¾ç”¨äºæµ‹è¯•æ›´æ–°
    spec:
      schedulerName: rescheduler-scheduler
      containers:
      - name: app
        image: nginx:1.20-alpine
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        env:
        - name: VERSION
          value: "v1"
        ports:
        - containerPort: 80

---
# ğŸš« æµ‹è¯•4ï¼šæ’é™¤é‡è°ƒåº¦çš„Pod
# æµ‹è¯•æ’é™¤æ ‡ç­¾åŠŸèƒ½
apiVersion: v1
kind: Pod
metadata:
  name: excluded-pod
  namespace: rescheduler-test
  labels:
    app: excluded-test
    test-type: exclusion
    # æ’é™¤é‡è°ƒåº¦çš„æ ‡ç­¾
    scheduler.alpha.kubernetes.io/rescheduling: "disabled"
spec:
  schedulerName: rescheduler-scheduler
  containers:
  - name: app
    image: busybox:latest
    command: ["sleep", "3600"]  # ç¡çœ 1å°æ—¶
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
  restartPolicy: Always

---
# ğŸ“Š æµ‹è¯•5ï¼šæœ‰çŠ¶æ€åº”ç”¨æµ‹è¯•
# æµ‹è¯•StatefulSetçš„é‡è°ƒåº¦è¡Œä¸º
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: stateful-test
  namespace: rescheduler-test
  labels:
    app: stateful-test
    test-type: statefulset
spec:
  serviceName: stateful-test-svc
  replicas: 3
  selector:
    matchLabels:
      app: stateful-test
  template:
    metadata:
      labels:
        app: stateful-test
        test-type: statefulset
    spec:
      schedulerName: rescheduler-scheduler
      containers:
      - name: app
        image: redis:alpine
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        ports:
        - containerPort: 6379
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 1Gi

---
# StatefulSet å¯¹åº”çš„ Service
apiVersion: v1
kind: Service
metadata:
  name: stateful-test-svc
  namespace: rescheduler-test
  labels:
    app: stateful-test
spec:
  clusterIP: None  # Headless service
  selector:
    app: stateful-test
  ports:
  - port: 6379
    targetPort: 6379

---
# ğŸ“ æµ‹è¯•è¯´æ˜å’Œå‘½ä»¤ ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-guide
  namespace: rescheduler-test
  labels:
    app: test-guide
data:
  README.md: |
    # é‡è°ƒåº¦å™¨æµ‹è¯•æŒ‡å—
    
    ## ğŸš€ æµ‹è¯•éƒ¨ç½²
    ```bash
    # éƒ¨ç½²æµ‹è¯•å·¥ä½œè´Ÿè½½
    kubectl apply -f manifests/rescheduler/examples/quick-test.yaml
    
    # éªŒè¯Podåˆ†å¸ƒ
    kubectl get pods -n rescheduler-test -o wide
    ```
    
    ## ğŸ“Š ç›‘æ§å‘½ä»¤
    ```bash
    # 1. è§‚å¯ŸPodåˆ†å¸ƒæƒ…å†µ
    kubectl get pods -n rescheduler-test -o wide | awk '{print $7}' | sort | uniq -c
    
    # 2. ç›‘æ§é‡è°ƒåº¦å™¨æ—¥å¿—
    kubectl logs -n kube-system -l app=rescheduler-scheduler -f
    
    # 3. æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨
    kubectl top nodes
    
    # 4. æŸ¥çœ‹Podèµ„æºä½¿ç”¨
    kubectl top pods -n rescheduler-test
    
    # 5. æŸ¥çœ‹é‡è°ƒåº¦äº‹ä»¶
    kubectl get events -n rescheduler-test --sort-by='.lastTimestamp'
    ```
    
    ## ğŸ§ª æµ‹è¯•åœºæ™¯
    
    ### è´Ÿè½½å‡è¡¡æµ‹è¯•
    - è§‚å¯Ÿ load-balance-test Pod åœ¨èŠ‚ç‚¹é—´çš„åˆ†å¸ƒ
    - ç­‰å¾…30ç§’è§‚å¯Ÿé‡è°ƒåº¦è¡Œä¸º
    
    ### èµ„æºå‹åŠ›æµ‹è¯•
    - resource-stress-test Pod ä¼šäº§ç”ŸCPUå’Œå†…å­˜å‹åŠ›
    - è§‚å¯Ÿæ˜¯å¦è§¦å‘èµ„æºä¼˜åŒ–é‡è°ƒåº¦
    
    ### æ’é™¤åŠŸèƒ½æµ‹è¯•
    - excluded-pod åº”è¯¥ä¸ä¼šè¢«é‡è°ƒåº¦
    - éªŒè¯æ’é™¤æ ‡ç­¾åŠŸèƒ½æ­£å¸¸
    
    ## ğŸ”„ æµ‹è¯•èŠ‚ç‚¹ç»´æŠ¤
    ```bash
    # æ ‡è®°èŠ‚ç‚¹ä¸ºç»´æŠ¤æ¨¡å¼
    kubectl label node <worker-node> scheduler.alpha.kubernetes.io/maintenance=true
    
    # è§‚å¯ŸPodè¿ç§»
    kubectl get pods -n rescheduler-test -o wide --watch
    
    # å–æ¶ˆç»´æŠ¤æ¨¡å¼
    kubectl label node <worker-node> scheduler.alpha.kubernetes.io/maintenance-
    ```
    
    ## ğŸ§¹ æ¸…ç†æµ‹è¯•
    ```bash
    # åˆ é™¤æµ‹è¯•å‘½åç©ºé—´ï¼ˆåŒ…å«æ‰€æœ‰æµ‹è¯•èµ„æºï¼‰
    kubectl delete namespace rescheduler-test
    
    # æˆ–è€…å•ç‹¬åˆ é™¤èµ„æº
    kubectl delete -f manifests/rescheduler/examples/quick-test.yaml
    ```
    
    ## ğŸ“ˆ é¢„æœŸè¡Œä¸º
    
    1. **è´Ÿè½½å‡è¡¡**: Podåº”è¯¥åœ¨30ç§’å†…é‡æ–°åˆ†å¸ƒä»¥å¹³è¡¡èŠ‚ç‚¹è´Ÿè½½
    2. **èµ„æºä¼˜åŒ–**: é«˜èµ„æºä½¿ç”¨çš„Podåº”è¯¥è§¦å‘å‘¨å›´Podçš„é‡è°ƒåº¦
    3. **æ’é™¤åŠŸèƒ½**: å¸¦æœ‰æ’é™¤æ ‡ç­¾çš„Podä¸åº”è¯¥è¢«é‡è°ƒåº¦
    4. **èŠ‚ç‚¹ç»´æŠ¤**: ç»´æŠ¤æ¨¡å¼çš„èŠ‚ç‚¹ä¸Šçš„Podåº”è¯¥è¢«è¿ç§»
    5. **è°ƒåº¦ä¼˜åŒ–**: æ–°Podåº”è¯¥ä¼˜å…ˆè°ƒåº¦åˆ°ä½è´Ÿè½½èŠ‚ç‚¹

  monitoring.sh: |
    #!/bin/bash
    # ç›‘æ§è„šæœ¬
    
    echo "ğŸ” å¼€å§‹ç›‘æ§é‡è°ƒåº¦å™¨æµ‹è¯•..."
    echo "======================="
    
    while true; do
      echo "ğŸ“Š $(date): Podåˆ†å¸ƒæƒ…å†µ"
      kubectl get pods -n rescheduler-test -o wide | awk 'NR>1 {print $7}' | sort | uniq -c
      
      echo "ğŸ“ˆ èŠ‚ç‚¹èµ„æºä½¿ç”¨:"
      kubectl top nodes 2>/dev/null || echo "metrics-serveræœªå®‰è£…"
      
      echo "----------------------"
      sleep 30
    done

  cleanup.sh: |
    #!/bin/bash
    # æ¸…ç†è„šæœ¬
    
    echo "ğŸ§¹ æ¸…ç†æµ‹è¯•èµ„æº..."
    kubectl delete namespace rescheduler-test
    echo "âœ… æµ‹è¯•èµ„æºå·²æ¸…ç†å®Œæˆ"
