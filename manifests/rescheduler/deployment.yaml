# 重调度器部署配置文件

---
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rescheduler-scheduler
  namespace: kube-system

---
# ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: rescheduler-scheduler
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["pods/binding"]
  verbs: ["create"]
- apiGroups: [""]
  resources: ["pods/status"] 
  verbs: ["patch", "update"]
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch", "update"]
- apiGroups: ["events.k8s.io"]
  resources: ["events"]
  verbs: ["create", "patch", "update"]
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["endpoints"]
  verbs: ["create", "get", "update"]
- apiGroups: ["apps"]
  resources: ["replicasets", "deployments", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["policy"]
  resources: ["poddisruptionbudgets"]
  verbs: ["get", "list", "watch"]

# 添加Pod驱逐权限 - 修复驱逐失败问题
- apiGroups: [""]
  resources: ["pods/eviction"]
  verbs: ["create"]
# 添加调度器需要的额外权限
- apiGroups: [""]
  resources: ["namespaces", "services", "replicationcontrollers", "persistentvolumes", "persistentvolumeclaims"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["configmaps"]
  resourceNames: ["extension-apiserver-authentication"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses", "volumeattachments", "csistoragecapacities", "csidrivers", "csinodes"]
  verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: rescheduler-scheduler
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: rescheduler-scheduler
subjects:
- kind: ServiceAccount
  name: rescheduler-scheduler
  namespace: kube-system

---
# ConfigMap for scheduler configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: rescheduler-config
  namespace: kube-system
data:
  config.yaml: |
    apiVersion: kubescheduler.config.k8s.io/v1
    kind: KubeSchedulerConfiguration
    leaderElection:
      leaderElect: true
      leaseDuration: 15s
      renewDeadline: 10s
      retryPeriod: 2s
      resourceLock: leases
      resourceNamespace: kube-system
      resourceName: rescheduler-scheduler
    clientConnection:
      kubeconfig: ""
    profiles:
      - schedulerName: rescheduler-scheduler
        plugins:
          # 在PreBind扩展点启用重调度器插件
          preBind:
            enabled:
            - name: Rescheduler
        pluginConfig:
        - name: Rescheduler
          args:
            reschedulingInterval: "30s"
            enabledStrategies:
              - "LoadBalancing"
              - "ResourceOptimization"
              - "NodeMaintenance"
            cpuThreshold: 80.0
            memoryThreshold: 80.0
            imbalanceThreshold: 20.0
            maxReschedulePods: 10
            excludedNamespaces:
              - "kube-system"
              - "kube-public"
              - "kube-node-lease"

---
# Deployment for Rescheduler Scheduler
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rescheduler-scheduler
  namespace: kube-system
  labels:
    app: rescheduler-scheduler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rescheduler-scheduler
  template:
    metadata:
      labels:
        app: rescheduler-scheduler
    spec:
      serviceAccountName: rescheduler-scheduler
      containers:
      - name: kube-scheduler
        image: scheduler-plugins:latest  # 使用本地构建的镜像
        imagePullPolicy: Never  # 强制使用本地镜像，不从远程拉取
        command:
        - /bin/kube-scheduler
        args:
        - --config=/etc/kubernetes/config.yaml
        - --v=2
        - --leader-elect=true
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - name: config
          mountPath: /etc/kubernetes
          readOnly: true
        livenessProbe:
          httpGet:
            path: /healthz
            port: 10259
            scheme: HTTPS
          initialDelaySeconds: 15
        readinessProbe:
          httpGet:
            path: /healthz
            port: 10259
            scheme: HTTPS
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534  # nobody user
      volumes:
      - name: config
        configMap:
          name: rescheduler-config
      tolerations:
      - key: "node-role.kubernetes.io/master"
        operator: "Equal"
        effect: "NoSchedule"
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Equal"
        effect: "NoSchedule"
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      priorityClassName: system-cluster-critical

---
# Service for monitoring (optional)
apiVersion: v1
kind: Service
metadata:
  name: rescheduler-scheduler-metrics
  namespace: kube-system
  labels:
    app: rescheduler-scheduler
spec:
  selector:
    app: rescheduler-scheduler
  ports:
  - name: https-metrics
    port: 10259
    targetPort: 10259
    protocol: TCP
