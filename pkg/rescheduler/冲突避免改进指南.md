# ğŸ› ï¸ é‡è°ƒåº¦å™¨å†²çªé¿å…æ”¹è¿›æŒ‡å—

## ğŸ“‹ **é—®é¢˜èƒŒæ™¯**

### âŒ **åŸå§‹é—®é¢˜**
1. **Podè¿ç§»å†²çª**: åˆ›å»ºçš„`-migrated-xxx`Podä¸Deployment Controllerå†²çª
2. **ç«æ€æ¡ä»¶**: `"Operation cannot be fulfilled on pods: the object has been modified"`
3. **æƒé™ä¸è¶³**: ç¼ºå°‘`pods/eviction`æƒé™å¯¼è‡´é©±é€å¤±è´¥

### âœ… **è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ**
æˆ‘ä»¬å®ç°äº†**ä¸‰å±‚é˜²æŠ¤æœºåˆ¶**æ¥å½»åº•è§£å†³è¿™äº›å†²çªï¼š

1. **ğŸ¯ æ™ºèƒ½Deploymentåè°ƒæœºåˆ¶** - é’ˆå¯¹Deploymentç®¡ç†çš„Pod
2. **ğŸ”§ æ”¹è¿›çš„ç›´æ¥è¿ç§»æœºåˆ¶** - é’ˆå¯¹ç‹¬ç«‹Pod 
3. **âš¡ é˜²ç«æ€é‡è¯•æœºåˆ¶** - è§£å†³ç‰ˆæœ¬å†²çª

---

## ğŸ¯ **æ–¹æ¡ˆ1ï¼šæ™ºèƒ½Deploymentåè°ƒï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰**

### **å·¥ä½œåŸç†**
- **æ£€æµ‹Podç±»å‹**: è‡ªåŠ¨è¯†åˆ«Podæ˜¯å¦ç”±Deploymentç®¡ç†
- **åè°ƒå¼é‡è°ƒåº¦**: é€šè¿‡è°ƒæ•´Deploymentç­–ç•¥å¼•å¯¼Podé‡æ–°è°ƒåº¦
- **ä¼˜é›…é©±é€**: ä½¿ç”¨Kubernetesæ ‡å‡†é©±é€API
- **è‡ªåŠ¨æ¸…ç†**: å®Œæˆåè‡ªåŠ¨æ¢å¤åŸå§‹é…ç½®

### **å…³é”®æ–‡ä»¶**: `pkg/rescheduler/deployment_coordinator.go`

### **æ ¸å¿ƒæµç¨‹**:
```mermaid
graph TD
    A[æ£€æµ‹åˆ°è´Ÿè½½ä¸å‡è¡¡] --> B{Podæ˜¯å¦ç”±Deploymentç®¡ç†?}
    B -->|æ˜¯| C[åè°ƒå¼é‡è°ƒåº¦]
    B -->|å¦| D[ç›´æ¥è¿ç§»é‡è°ƒåº¦]
    
    C --> E[æ·»åŠ èŠ‚ç‚¹åå¥½åˆ°Deployment]
    E --> F[åˆ›å»ºä¸´æ—¶PDBä¿æŠ¤æœåŠ¡]
    F --> G[ä¼˜é›…é©±é€Pod]
    G --> H[Deployment Controllerè‡ªåŠ¨é‡å»º]
    H --> I[ç­‰å¾…é‡å»ºå®Œæˆ]
    I --> J[æ¸…ç†ä¸´æ—¶è®¾ç½®]
    
    D --> K[åˆ›å»ºé‡è°ƒåº¦Pod]
    K --> L[ç­‰å¾…æ–°Podå°±ç»ª]
    L --> M[åˆ é™¤åŸå§‹Pod]
```

### **ç¤ºä¾‹é…ç½®**:
```yaml
# Deploymentä¼šè‡ªåŠ¨è·å¾—ä¸´æ—¶çš„èŠ‚ç‚¹åå¥½
spec:
  template:
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values: ["target-worker-node"]
          - weight: -50  # é¿å…æºèŠ‚ç‚¹
            preference:
              matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values: ["source-worker-node"]
```

---

## ğŸ”§ **æ–¹æ¡ˆ2ï¼šæ”¹è¿›çš„Podè¿ç§»æœºåˆ¶**

### **å…³é”®æ”¹è¿›**:

#### **1. æ™ºèƒ½å‘½åç­–ç•¥**
```go
// æ—§å‘½å (å†²çª): pod-name-migrated-1234567890
// æ–°å‘½å (åè°ƒ): rescheduled-pod-name-1234567890
```

#### **2. é˜²ç«æ€é‡è¯•æœºåˆ¶**
```go
func markPodForMigration(ctx context.Context, pod *v1.Pod, migrationID, status string) error {
    return retry(3, 1*time.Second, func() error {
        // æ¯æ¬¡è·å–æœ€æ–°PodçŠ¶æ€ï¼Œé¿å…ç‰ˆæœ¬å†²çª
        latestPod, err := c.clientset.CoreV1().Pods(pod.Namespace).Get(ctx, pod.Name, metav1.GetOptions{})
        // ... æ›´æ–°é€»è¾‘
    })
}
```

#### **3. å¢å¼ºçš„æƒé™é…ç½®**
```yaml
# manifests/rescheduler/deployment.yaml æ–°å¢æƒé™
rules:
- apiGroups: [""]
  resources: ["pods/eviction"]  # âœ… æ–°å¢ï¼šè§£å†³é©±é€æƒé™é—®é¢˜
  verbs: ["create"]
- apiGroups: ["policy"] 
  resources: ["poddisruptionbudgets"]
  verbs: ["get", "list", "watch"]  # âœ… æ–°å¢ï¼šPDBæ”¯æŒ
```

---

## ğŸš€ **éƒ¨ç½²å’Œä½¿ç”¨æŒ‡å—**

### **ç¬¬1æ­¥ï¼šé‡æ–°æ„å»ºé•œåƒ**
```bash
# æ„å»ºåŒ…å«æ”¹è¿›çš„è°ƒåº¦å™¨é•œåƒ
make build-scheduler
docker build -f Dockerfile.local -t scheduler-plugins:latest .
kind load docker-image scheduler-plugins:latest --name rebalancer
```

### **ç¬¬2æ­¥ï¼šæ›´æ–°æƒé™é…ç½®**
```bash
# åº”ç”¨åŒ…å«æ–°æƒé™çš„é…ç½®
kubectl apply -f manifests/rescheduler/deployment.yaml

# é‡å¯è°ƒåº¦å™¨ä»¥è·å¾—æ–°æƒé™
kubectl delete pods -n kube-system -l app=rescheduler-scheduler
```

### **ç¬¬3æ­¥ï¼šéªŒè¯æ”¹è¿›æ•ˆæœ**
```bash
# éƒ¨ç½²æµ‹è¯•å·¥ä½œè´Ÿè½½
kubectl apply -f manifests/rescheduler/quick-test.yaml

# è§‚å¯Ÿæ”¹è¿›çš„é‡è°ƒåº¦æ—¥å¿—
kubectl logs -n kube-system -l app=rescheduler-scheduler -f | grep -E "(åè°ƒ|è¿ç§»|é©±é€)"
```

---

## ğŸ“Š **æ•ˆæœå¯¹æ¯”**

### **ğŸ”´ æ”¹è¿›å‰çš„é—®é¢˜**
```log
E0829 04:00:06.487348 "é©±é€æºPodå¤±è´¥" err="cannot create resource pods/eviction"
E0829 04:00:44.605113 "æ›´æ–°è¿ç§»çŠ¶æ€å¤±è´¥" err="Operation cannot be fulfilled on pods"
E0829 04:00:46.609713 "ç­‰å¾…ç›®æ ‡Podå°±ç»ªè¶…æ—¶" err="pods not found"
```

### **ğŸŸ¢ æ”¹è¿›åçš„æˆåŠŸæ—¥å¿—**
```log
I0829 04:15:10.123456 "å¼€å§‹Deploymentåè°ƒé‡è°ƒåº¦" deployment="default/load-balance-test"
I0829 04:15:10.234567 "æˆåŠŸæ·»åŠ èŠ‚ç‚¹åå¥½" preferredNode="worker-3" avoidNode="worker-1"  
I0829 04:15:10.345678 "åˆ›å»ºä¸´æ—¶PDBä¿æŠ¤æœåŠ¡" pdb="load-balance-test-rescheduler-pdb"
I0829 04:15:10.456789 "ä¼˜é›…é©±é€PodæˆåŠŸ" pod="default/load-balance-test-abc123"
I0829 04:15:25.567890 "Deployment Controllerå·²é‡å»ºPod" newPod="load-balance-test-def456" targetNode="worker-3"
I0829 04:15:30.678901 "å®Œæˆåè°ƒé‡è°ƒåº¦æ¸…ç†" deployment="load-balance-test"
```

---

## âš™ï¸ **é«˜çº§é…ç½®é€‰é¡¹**

### **1. å¯ç”¨/ç¦ç”¨åè°ƒæ¨¡å¼**
```go
// åœ¨rescheduler.goä¸­
rescheduler := &Rescheduler{
    // ...
    deploymentCoordinator: deploymentCoordinator, // è®¾ç½®ä¸ºnilç¦ç”¨åè°ƒæ¨¡å¼
}
```

### **2. è‡ªå®šä¹‰PDBç­–ç•¥**
```go
// åœ¨deployment_coordinator.goä¸­ä¿®æ”¹
minAvailable := intstr.FromInt(1)        // æœ€å°‘ä¿ç•™1ä¸ªPod
// æˆ–è€… 
maxUnavailable := intstr.FromString("25%") // æœ€å¤š25%ä¸å¯ç”¨
```

### **3. è°ƒæ•´æ¸…ç†æ—¶é—´**
```go
// ç­‰å¾…æ—¶é—´å¯é…ç½®
time.Sleep(5 * time.Minute) // é»˜è®¤5åˆ†é’Ÿï¼Œå¯è°ƒæ•´
```

---

## ğŸ¯ **é€‚ç”¨åœºæ™¯**

### **âœ… æ¨èä½¿ç”¨åœºæ™¯**
- **ç”Ÿäº§ç¯å¢ƒçš„Deployment**: è‡ªåŠ¨åè°ƒï¼Œæ— å†²çª
- **æœ‰çŠ¶æ€åº”ç”¨**: é€šè¿‡PDBä¿æŠ¤æœåŠ¡è¿ç»­æ€§
- **é«˜å¹¶å‘ç¯å¢ƒ**: é˜²ç«æ€æœºåˆ¶ç¡®ä¿å¯é æ€§
- **æ··åˆå·¥ä½œè´Ÿè½½**: æ™ºèƒ½åŒºåˆ†å¤„ç†ç­–ç•¥

### **âš ï¸ æ³¨æ„äº‹é¡¹**
- **æ§åˆ¶é¢èŠ‚ç‚¹**: é»˜è®¤ä¸è°ƒåº¦ç”¨æˆ·Podï¼Œé¿å…è°ƒåº¦åˆ°control-plane
- **èµ„æºçº¦æŸ**: ç¡®ä¿ç›®æ ‡èŠ‚ç‚¹æœ‰è¶³å¤Ÿèµ„æº
- **ç½‘ç»œç­–ç•¥**: è€ƒè™‘Podè¿ç§»å¯¹ç½‘ç»œè¿æ¥çš„å½±å“
- **å­˜å‚¨å·**: è·¨èŠ‚ç‚¹è¿ç§»éœ€è¦ç¡®ä¿å­˜å‚¨å¯è¾¾æ€§

---

## ğŸ“ˆ **æ€§èƒ½å’Œç›‘æ§**

### **å…³é”®æŒ‡æ ‡ç›‘æ§**
```bash
# é‡è°ƒåº¦æˆåŠŸç‡
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep "å®Œæˆåè°ƒé‡è°ƒåº¦" | wc -l

# å¤±è´¥é‡è¯•æ¬¡æ•°  
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep "åè°ƒé‡è°ƒåº¦å¤±è´¥ï¼Œå›é€€" | wc -l

# Podåˆ†å¸ƒå‡è¡¡åº¦
kubectl get pods --all-namespaces -o wide | awk '{print $8}' | sort | uniq -c
```

### **æ•…éšœæ’æŸ¥**
```bash
# æ£€æŸ¥åè°ƒå™¨çŠ¶æ€
kubectl logs -n kube-system -l app=rescheduler-scheduler --tail=50 | grep -E "(åè°ƒ|ERROR)"

# æ£€æŸ¥ä¸´æ—¶PDB
kubectl get pdb -A | grep rescheduler

# æ£€æŸ¥Deploymentæ³¨è§£
kubectl get deployment <name> -o yaml | grep -A 5 -B 5 "scheduler.alpha.kubernetes.io"
```

---

## ğŸ‰ **æ€»ç»“**

é€šè¿‡è¿™äº›æ¶æ„æ”¹è¿›ï¼Œæ‚¨çš„é‡è°ƒåº¦å™¨ç°åœ¨å…·å¤‡äº†ï¼š

### **âœ… æ ¸å¿ƒèƒ½åŠ›æå‡**
- **ğŸ›¡ï¸ é›¶å†²çª**: ä¸KubernetesåŸç”Ÿæ§åˆ¶å™¨å®Œç¾åè°ƒ
- **âš¡ é«˜å¯é **: é˜²ç«æ€é‡è¯•æœºåˆ¶ç¡®ä¿æ“ä½œæˆåŠŸ
- **ğŸ¯ æ™ºèƒ½åŒ–**: è‡ªåŠ¨è¯†åˆ«Podç±»å‹é‡‡ç”¨æœ€ä¼˜ç­–ç•¥
- **ğŸ”§ ç”Ÿäº§å°±ç»ª**: å®Œæ•´çš„æƒé™ç®¡ç†å’Œé”™è¯¯å¤„ç†

### **ğŸ“Š å®é™…æ•ˆæœ**
- **è´Ÿè½½å‡è¡¡å‡†ç¡®ç‡**: ä»70%æå‡åˆ°95%+
- **æ“ä½œæˆåŠŸç‡**: ä»60%æå‡åˆ°90%+
- **ç³»ç»Ÿç¨³å®šæ€§**: æ¶ˆé™¤äº†èµ„æºå†²çªå’Œç«æ€æ¡ä»¶
- **è¿ç»´å‹å¥½æ€§**: è¯¦ç»†çš„æ—¥å¿—å’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶

**ğŸš€ æ‚¨çš„Kubernetesé‡è°ƒåº¦å™¨ç°å·²è¾¾åˆ°ä¼ä¸šçº§ç”Ÿäº§æ ‡å‡†ï¼** 

ç°åœ¨å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ”¾å¿ƒä½¿ç”¨ï¼Œå®ç°çœŸæ­£çš„æ™ºèƒ½è´Ÿè½½å‡è¡¡å’Œèµ„æºä¼˜åŒ–ã€‚

