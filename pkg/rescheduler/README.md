# Rescheduler Plugin - é‡è°ƒåº¦æ’ä»¶

## æ¦‚è¿°

Rescheduleræ’ä»¶æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„Kubernetes Podé‡è°ƒåº¦è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤ŸæŒç»­ç›‘æ§é›†ç¾¤çŠ¶æ€å¹¶æ ¹æ®å¤šç§ç­–ç•¥è‡ªåŠ¨é‡æ–°è°ƒåº¦Podï¼Œä»¥ä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡å’Œé›†ç¾¤æ€§èƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸš€ å¤šç§é‡è°ƒåº¦ç­–ç•¥

1. **è´Ÿè½½å‡è¡¡ (LoadBalancing)**
   - ç›‘æ§èŠ‚ç‚¹é—´çš„è´Ÿè½½åˆ†å¸ƒ
   - è‡ªåŠ¨å°†Podä»é«˜è´Ÿè½½èŠ‚ç‚¹è¿ç§»åˆ°ä½è´Ÿè½½èŠ‚ç‚¹
   - ç»´æŒé›†ç¾¤æ•´ä½“è´Ÿè½½å¹³è¡¡

2. **èµ„æºä¼˜åŒ– (ResourceOptimization)**
   - ç›‘æ§èŠ‚ç‚¹CPUå’Œå†…å­˜ä½¿ç”¨ç‡
   - å½“èŠ‚ç‚¹èµ„æºä½¿ç”¨è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘é‡è°ƒåº¦
   - ä¼˜åŒ–æ•´ä½“èµ„æºåˆ©ç”¨æ•ˆç‡

3. **èŠ‚ç‚¹ç»´æŠ¤ (NodeMaintenance)**
   - æ”¯æŒèŠ‚ç‚¹ç»´æŠ¤æ¨¡å¼
   - è‡ªåŠ¨è¿ç§»ç»´æŠ¤èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Pod
   - ç¡®ä¿æœåŠ¡ä¸ä¸­æ–­

### ğŸ›¡ï¸ å®‰å…¨æ€§ä¿éšœ

- **æ™ºèƒ½Podç­›é€‰**: è‡ªåŠ¨æ’é™¤ç³»ç»ŸPodã€DaemonSet Podå’Œé™æ€Pod
- **å‘½åç©ºé—´éš”ç¦»**: æ”¯æŒæ’é™¤æŒ‡å®šå‘½åç©ºé—´
- **ä¼˜å…ˆçº§æ„ŸçŸ¥**: ä¼˜å…ˆè¿ç§»ä½ä¼˜å…ˆçº§Pod
- **æ ‡ç­¾æ§åˆ¶**: æ”¯æŒé€šè¿‡æ ‡ç­¾æ§åˆ¶Podæ˜¯å¦å‚ä¸é‡è°ƒåº¦

### âš™ï¸ å¯é…ç½®å‚æ•°

- é‡è°ƒåº¦é—´éš”æ—¶é—´
- èµ„æºä½¿ç”¨ç‡é˜ˆå€¼
- è´Ÿè½½ä¸å‡è¡¡é˜ˆå€¼
- æœ€å¤§é‡è°ƒåº¦Podæ•°é‡
- æ’é™¤è§„åˆ™

## ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®è°ƒåº¦å™¨

åœ¨è°ƒåº¦å™¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨Rescheduleræ’ä»¶ï¼š

```yaml
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
leaderElection:
  leaderElect: false
clientConnection:
  kubeconfig: "/path/to/your/kubeconfig"
profiles:
  - schedulerName: rescheduler-scheduler
    plugins:
      # Rescheduleræ’ä»¶ä¼šåœ¨åå°è¿è¡Œï¼Œä¸éœ€è¦ç‰¹å®šçš„æ‰©å±•ç‚¹
    pluginConfig:
      - name: Rescheduler
        args:
          reschedulingInterval: "30s"
          enabledStrategies:
            - "LoadBalancing"
            - "ResourceOptimization"
            - "NodeMaintenance"
          cpuThreshold: 80.0
          memoryThreshold: 80.0
          imbalanceThreshold: 20.0
          maxReschedulePods: 10
          excludedNamespaces:
            - "kube-system"
            - "kube-public"
```

### 2. å¯åŠ¨è°ƒåº¦å™¨

```bash
# ç¼–è¯‘è°ƒåº¦å™¨
make build

# è¿è¡Œè°ƒåº¦å™¨
./bin/kube-scheduler --config=manifests/rescheduler/scheduler-config.yaml --v=2
```

### 3. æ§åˆ¶Podé‡è°ƒåº¦è¡Œä¸º

#### æ’é™¤Podå‚ä¸é‡è°ƒåº¦

ä¸ºPodæ·»åŠ æ ‡ç­¾æ¥æ’é™¤é‡è°ƒåº¦ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  labels:
    scheduler.alpha.kubernetes.io/rescheduling: "disabled"
spec:
  # ... pod spec
```

#### èŠ‚ç‚¹ç»´æŠ¤æ¨¡å¼

ä¸ºèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾å¯ç”¨ç»´æŠ¤æ¨¡å¼ï¼š

```bash
kubectl label node worker-1 scheduler.alpha.kubernetes.io/maintenance=true
```

## å·¥ä½œåŸç†

### ç›‘æ§å’Œåˆ†æ
1. **æŒç»­ç›‘æ§**: å®šæœŸæ”¶é›†æ‰€æœ‰èŠ‚ç‚¹å’ŒPodçš„çŠ¶æ€ä¿¡æ¯
2. **èµ„æºè®¡ç®—**: è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„CPUã€å†…å­˜ä½¿ç”¨ç‡å’ŒPodåˆ†å¸ƒ
3. **ç­–ç•¥è¯„ä¼°**: æ ¹æ®é…ç½®çš„ç­–ç•¥è¯„ä¼°æ˜¯å¦éœ€è¦é‡è°ƒåº¦

### å†³ç­–åˆ¶å®š
1. **è´Ÿè½½åˆ†æ**: è¯†åˆ«é«˜è´Ÿè½½å’Œä½è´Ÿè½½èŠ‚ç‚¹
2. **Podç­›é€‰**: é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„å¯è¿ç§»Pod
3. **ç›®æ ‡é€‰æ‹©**: ä¸ºæ¯ä¸ªPodé€‰æ‹©æœ€ä¼˜çš„ç›®æ ‡èŠ‚ç‚¹

### å®‰å…¨è¿ç§»
1. **åˆ›å»ºå‰¯æœ¬**: åœ¨ç›®æ ‡èŠ‚ç‚¹åˆ›å»ºPodå‰¯æœ¬
2. **çŠ¶æ€éªŒè¯**: ç­‰å¾…æ–°Podæ­£å¸¸è¿è¡Œ
3. **ä¼˜é›…åˆ é™¤**: åˆ é™¤åŸå§‹Pod

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ç¤ºä¾‹

```
I1201 10:30:15.123456 1 rescheduler.go:120] é‡è°ƒåº¦å™¨å¼€å§‹è¿è¡Œ interval=30s
I1201 10:30:45.234567 1 rescheduler.go:145] å¼€å§‹æ‰§è¡Œé‡è°ƒåº¦æ£€æŸ¥
I1201 10:30:45.345678 1 rescheduler.go:380] å¼€å§‹æ‰§è¡ŒPodè¿ç§» pod=default/nginx-abc123 sourceNode=worker-1 targetNode=worker-2 reason="è´Ÿè½½å‡è¡¡: æºèŠ‚ç‚¹ä½¿ç”¨ç‡85.0%, ç›®æ ‡èŠ‚ç‚¹ä½¿ç”¨ç‡45.0%" strategy=LoadBalancing
I1201 10:30:45.456789 1 rescheduler.go:425] æˆåŠŸåˆ›å»ºè¿ç§»Pod newPod=default/nginx-abc123-migrated-1701421845
I1201 10:31:15.567890 1 rescheduler.go:445] æˆåŠŸåˆ é™¤åŸPod pod=default/nginx-abc123
I1201 10:30:45.678901 1 rescheduler.go:185] å®Œæˆé‡è°ƒåº¦æ“ä½œ é‡è°ƒåº¦Podæ•°é‡=3
```

### è¿ç§»Podæ ‡è¯†

è¿ç§»åçš„Podä¼šåŒ…å«ä»¥ä¸‹æ ‡ç­¾å’Œæ³¨è§£ï¼š

**æ ‡ç­¾:**
- `scheduler.alpha.kubernetes.io/migrated-from`: åŸå§‹èŠ‚ç‚¹åç§°
- `scheduler.alpha.kubernetes.io/migration-reason`: è¿ç§»ç­–ç•¥

**æ³¨è§£:**
- `scheduler.alpha.kubernetes.io/migration-time`: è¿ç§»æ—¶é—´
- `scheduler.alpha.kubernetes.io/original-pod`: åŸå§‹Pod UID

## é…ç½®å‚æ•°è¯¦è§£

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `reschedulingInterval` | duration | 30s | é‡è°ƒåº¦æ£€æŸ¥é—´éš” |
| `enabledStrategies` | []string | ["LoadBalancing", "ResourceOptimization"] | å¯ç”¨çš„é‡è°ƒåº¦ç­–ç•¥ |
| `cpuThreshold` | float64 | 80.0 | CPUä½¿ç”¨ç‡é˜ˆå€¼(%) |
| `memoryThreshold` | float64 | 80.0 | å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼(%) |
| `imbalanceThreshold` | float64 | 20.0 | è´Ÿè½½ä¸å‡è¡¡é˜ˆå€¼(%) |
| `maxReschedulePods` | int | 10 | å•æ¬¡é‡è°ƒåº¦æœ€å¤§Podæ•°é‡ |
| `excludedNamespaces` | []string | ["kube-system", "kube-public"] | æ’é™¤çš„å‘½åç©ºé—´ |
| `excludedPodSelector` | string | "" | æ’é™¤çš„Podæ ‡ç­¾é€‰æ‹©å™¨ |

## æœ€ä½³å®è·µ

### 1. é…ç½®å»ºè®®
- æ ¹æ®é›†ç¾¤è§„æ¨¡è°ƒæ•´é‡è°ƒåº¦é—´éš”
- è®¾ç½®åˆç†çš„èµ„æºé˜ˆå€¼ï¼Œé¿å…é¢‘ç¹è¿ç§»
- é™åˆ¶å•æ¬¡é‡è°ƒåº¦Podæ•°é‡ï¼Œç¡®ä¿é›†ç¾¤ç¨³å®š

### 2. ç›‘æ§å»ºè®®
- ç›‘æ§é‡è°ƒåº¦é¢‘ç‡å’ŒæˆåŠŸç‡
- è§‚å¯Ÿé›†ç¾¤è´Ÿè½½åˆ†å¸ƒå˜åŒ–
- å…³æ³¨Podè¿ç§»å¯¹åº”ç”¨çš„å½±å“

### 3. æ•…éšœæ’é™¤
- æ£€æŸ¥è°ƒåº¦å™¨æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯
- éªŒè¯èŠ‚ç‚¹èµ„æºçŠ¶æ€
- ç¡®è®¤Podå’ŒèŠ‚ç‚¹æ ‡ç­¾é…ç½®

## æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦æé†’

1. **æœ‰çŠ¶æ€åº”ç”¨**: è°¨æ…å¯¹æœ‰çŠ¶æ€åº”ç”¨ä½¿ç”¨é‡è°ƒåº¦ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
2. **ç½‘ç»œä¾èµ–**: è€ƒè™‘Podè¿ç§»å¯¹ç½‘ç»œè¿æ¥çš„å½±å“
3. **èµ„æºé™åˆ¶**: ç¡®ä¿ç›®æ ‡èŠ‚ç‚¹æœ‰è¶³å¤Ÿèµ„æºè¿è¡Œè¿ç§»çš„Pod
4. **æµ‹è¯•ç¯å¢ƒ**: å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é‡è°ƒåº¦ç­–ç•¥

### ğŸ”’ å®‰å…¨è€ƒè™‘

- é‡è°ƒåº¦å™¨éœ€è¦é›†ç¾¤çº§åˆ«çš„Podè¯»å†™æƒé™
- å»ºè®®ä½¿ç”¨RBACé™åˆ¶æƒé™èŒƒå›´
- ç›‘æ§é‡è°ƒåº¦æ“ä½œçš„å®¡è®¡æ—¥å¿—

## å‘å±•è·¯çº¿

- [ ] æ”¯æŒæ›´å¤šé‡è°ƒåº¦ç­–ç•¥ï¼ˆæ‹“æ‰‘æ„ŸçŸ¥ã€æˆæœ¬ä¼˜åŒ–ç­‰ï¼‰
- [ ] å®ç°æ›´ç²¾ç¡®çš„èµ„æºä½¿ç”¨ç‡è®¡ç®—
- [ ] æ”¯æŒPodç»„çº§åˆ«çš„é‡è°ƒåº¦
- [ ] é›†æˆPrometheusæŒ‡æ ‡
- [ ] Web UIç®¡ç†ç•Œé¢

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç ã€æŠ¥å‘Šé—®é¢˜æˆ–æå‡ºæ”¹è¿›å»ºè®®ï¼

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache 2.0 è®¸å¯è¯ã€‚
