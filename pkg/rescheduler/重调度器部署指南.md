# 🚀 Kubernetes重调度器插件 - 完整部署指南

## 📋 项目概述

本项目实现了一个智能的Kubernetes Pod重调度器插件，支持以下核心功能：
- **负载均衡策略** (LoadBalancing): 自动平衡节点间Pod分布
- **资源优化策略** (ResourceOptimization): 基于CPU/内存使用率重调度
- **节点维护策略** (NodeMaintenance): 支持节点维护模式
- **可配置参数**: 支持自定义间隔、阈值等参数

## 🛠️ 环境准备

### 前置条件
- Kubernetes集群 (Kind/Minikube/真实集群)
- Docker环境
- kubectl命令行工具
- Go 1.24+ (用于构建)

### Kind集群快速搭建 (推荐)
```bash
# 创建Kind集群配置
cat > kind-config.yaml << EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: scheduler-demo
nodes:
- role: control-plane
- role: worker
- role: worker  
- role: worker
EOF

# 创建集群
kind create cluster --config kind-config.yaml
```

## 📦 快速开始

### 第一步：构建项目
```bash
# 1. 克隆/进入项目目录
cd scheduler-plugins

# 2. 构建调度器二进制
make build-scheduler

# 3. 构建Docker镜像
docker build -f Dockerfile.local -t scheduler-plugins:latest .

# 4. (Kind集群) 加载镜像到集群
kind load docker-image scheduler-plugins:latest --name scheduler-demo
```

### 第二步：部署重调度器
```bash
# 1. 应用重调度器部署
kubectl apply -f manifests/rescheduler/deployment.yaml

# 2. 验证部署状态
kubectl get pods -n kube-system -l app=rescheduler-scheduler

# 3. 查看日志确认启动
kubectl logs -n kube-system -l app=rescheduler-scheduler --tail=20
```

**预期日志输出**：
```
I0829 03:13:40.048948 1 rescheduler.go:112] "重调度器插件正在初始化"
I0829 03:13:40.049267 1 rescheduler.go:159] "重调度器开始运行" interval="30s"
```

### 第三步：部署测试Pod
```bash
# 1. 部署负载测试
kubectl apply -f manifests/rescheduler/test-pods.yaml

# 2. 查看初始Pod分布
kubectl get pods --all-namespaces -o wide | awk '{print $8}' | sort | uniq -c
```

### 第四步：观察重调度过程
```bash
# 1. 实时监控重调度日志
kubectl logs -n kube-system -l app=rescheduler-scheduler -f

# 2. 监控Pod分布变化
watch "kubectl get pods --all-namespaces -o wide | awk '{print \$8}' | sort | uniq -c"
```

**预期重调度日志**：
```
I0829 03:14:10.050254 1 rescheduler.go:170] "开始执行重调度检查"
I0829 03:14:10.050856 1 controller.go:252] "开始执行Pod迁移" 
  strategy="LoadBalancing" sourceNode="worker1" targetNode="worker2"
I0829 03:14:10.087521 1 controller.go:372] "成功创建目标Pod"
I0829 03:14:10.113996 1 rescheduler.go:219] "完成重调度操作" 重调度Pod数量=2
```

## ⚙️ 配置参数

### 重调度器配置 (manifests/rescheduler/deployment.yaml)
```yaml
pluginConfig:
- name: Rescheduler
  args:
    reschedulingInterval: "30s"     # 重调度检查间隔
    enabledStrategies:              # 启用的策略
      - "LoadBalancing"
      - "ResourceOptimization"
      - "NodeMaintenance"
    cpuThreshold: 80.0             # CPU使用率阈值(%)
    memoryThreshold: 80.0          # 内存使用率阈值(%)
    imbalanceThreshold: 20.0       # 负载不均衡阈值(%)
    maxReschedulePods: 10          # 单次最大重调度Pod数
    excludedNamespaces:            # 排除的命名空间
      - "kube-system"
      - "kube-public"
```

### 测试场景配置
```yaml
# 1. 负载均衡测试 - 强制所有Pod到一个节点
nodeSelector:
  kubernetes.io/hostname: worker-node-1

# 2. 资源压力测试 - 高资源请求
resources:
  requests:
    cpu: 200m
    memory: 256Mi

# 3. 节点维护测试
kubectl label node worker-1 scheduler.alpha.kubernetes.io/maintenance=true
```

## 🧪 测试场景

### 场景1：负载均衡测试
```bash
# 创建不均衡负载
kubectl create deployment heavy-load --image=nginx --replicas=20
kubectl patch deployment heavy-load -p '{"spec":{"template":{"spec":{"nodeSelector":{"kubernetes.io/hostname":"worker-1"}}}}}'

# 等待重调度器自动平衡 (30秒周期)
# 观察Pod重新分布到其他节点
```

### 场景2：节点维护测试
```bash
# 标记节点进入维护模式
kubectl label node worker-1 scheduler.alpha.kubernetes.io/maintenance=true

# 观察该节点上的Pod被自动迁移
kubectl get pods -o wide --field-selector spec.nodeName=worker-1

# 退出维护模式
kubectl label node worker-1 scheduler.alpha.kubernetes.io/maintenance-
```

### 场景3：资源优化测试
```bash
# 创建高CPU使用的Pod
kubectl run cpu-hog --image=progrium/stress --restart=Never -- --cpu 2
kubectl label pod cpu-hog scheduler.alpha.kubernetes.io/rescheduling=enabled

# 观察重调度器基于资源使用率进行优化
```

## 📊 监控和故障排查

### 重要监控指标
```bash
# 1. 重调度器状态
kubectl get pods -n kube-system -l app=rescheduler-scheduler

# 2. 重调度操作统计
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep "完成重调度操作"

# 3. 节点资源使用
kubectl top nodes

# 4. Pod分布统计
kubectl get pods --all-namespaces -o wide | awk '{print $8}' | sort | uniq -c
```

### 常见问题排查

**问题1: 重调度器Pod无法启动**
```bash
# 检查镜像是否存在
docker images | grep scheduler-plugins

# 检查权限配置
kubectl describe pod -n kube-system -l app=rescheduler-scheduler

# 解决方案: 确保镜像已加载到集群节点
kind load docker-image scheduler-plugins:latest --name your-cluster
```

**问题2: 没有重调度活动**
```bash
# 检查插件是否正确加载
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep "重调度器插件正在初始化"

# 检查负载是否满足重调度条件
kubectl get pods -o wide | awk '{print $7}' | sort | uniq -c

# 解决方案: 创建更明显的负载不均衡测试场景
```

**问题3: Pod迁移失败**
```bash
# 查看详细错误日志
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep -E "(失败|Error)"

# 常见原因: Pod有nodeSelector约束
kubectl get pod <pod-name> -o yaml | grep -A5 nodeSelector

# 解决方案: 移除约束或配置排除标签
```

## 🔧 高级配置

### 自定义策略权重
```yaml
# 在代码中调整策略优先级
const (
    LoadBalancingWeight        = 100
    ResourceOptimizationWeight = 80
    NodeMaintenanceWeight      = 120
)
```

### 扩展新的重调度策略
```go
// 添加新策略到 enabledStrategies
const CustomStrategy = "CustomStrategy"

// 在重调度逻辑中实现新策略
func (r *Rescheduler) evaluateCustomStrategy(nodes []*NodeResourceUsage) []*ReschedulingDecision {
    // 自定义重调度逻辑
}
```

## 📁 项目结构
```
scheduler-plugins/
├── pkg/rescheduler/           # 重调度器核心代码
│   ├── rescheduler.go         # 主要插件逻辑
│   ├── controller.go          # 迁移控制器
│   └── README.md              # 详细文档
├── manifests/rescheduler/     # 部署配置
│   ├── deployment.yaml        # 完整部署配置
│   └── test-pods.yaml         # 测试Pod配置
├── cmd/scheduler/             # 调度器入口
└── Dockerfile.local           # 镜像构建文件
```

## 🚀 生产环境部署建议

1. **资源配置**: 根据集群规模调整调度器Pod的资源请求
2. **监控集成**: 配置Prometheus指标收集
3. **高可用**: 启用leader选举，部署多副本
4. **安全配置**: 使用最小权限原则配置RBAC
5. **日志管理**: 配置日志轮转和集中收集

## 📞 支持和贡献

- 🐛 Bug报告: 提交Issue描述问题和重现步骤
- 💡 功能建议: 在Issue中提出新功能想法
- 🔧 代码贡献: Fork项目并提交Pull Request
- 📖 文档改进: 帮助完善文档和示例

---

**恭喜！您已成功部署并测试了自定义的Kubernetes重调度器插件！** 🎉
