# ğŸš€ Kubernetesé‡è°ƒåº¦å™¨æ’ä»¶ - å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªæ™ºèƒ½çš„Kubernetes Podé‡è°ƒåº¦å™¨æ’ä»¶ï¼Œæ”¯æŒä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
- **è´Ÿè½½å‡è¡¡ç­–ç•¥** (LoadBalancing): è‡ªåŠ¨å¹³è¡¡èŠ‚ç‚¹é—´Podåˆ†å¸ƒ
- **èµ„æºä¼˜åŒ–ç­–ç•¥** (ResourceOptimization): åŸºäºCPU/å†…å­˜ä½¿ç”¨ç‡é‡è°ƒåº¦
- **èŠ‚ç‚¹ç»´æŠ¤ç­–ç•¥** (NodeMaintenance): æ”¯æŒèŠ‚ç‚¹ç»´æŠ¤æ¨¡å¼
- **å¯é…ç½®å‚æ•°**: æ”¯æŒè‡ªå®šä¹‰é—´éš”ã€é˜ˆå€¼ç­‰å‚æ•°

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### å‰ç½®æ¡ä»¶
- Kubernetesé›†ç¾¤ (Kind/Minikube/çœŸå®é›†ç¾¤)
- Dockerç¯å¢ƒ
- kubectlå‘½ä»¤è¡Œå·¥å…·
- Go 1.24+ (ç”¨äºæ„å»º)

### Kindé›†ç¾¤å¿«é€Ÿæ­å»º (æ¨è)
```bash
# åˆ›å»ºKindé›†ç¾¤é…ç½®
cat > kind-config.yaml << EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: scheduler-demo
nodes:
- role: control-plane
- role: worker
- role: worker  
- role: worker
EOF

# åˆ›å»ºé›†ç¾¤
kind create cluster --config kind-config.yaml
```

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šæ„å»ºé¡¹ç›®
```bash
# 1. å…‹éš†/è¿›å…¥é¡¹ç›®ç›®å½•
cd scheduler-plugins

# 2. æ„å»ºè°ƒåº¦å™¨äºŒè¿›åˆ¶
make build-scheduler

# 3. æ„å»ºDockeré•œåƒ
docker build -f Dockerfile.local -t scheduler-plugins:latest .

# 4. (Kindé›†ç¾¤) åŠ è½½é•œåƒåˆ°é›†ç¾¤
kind load docker-image scheduler-plugins:latest --name scheduler-demo
```

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²é‡è°ƒåº¦å™¨
```bash
# 1. åº”ç”¨é‡è°ƒåº¦å™¨éƒ¨ç½²
kubectl apply -f manifests/rescheduler/deployment.yaml

# 2. éªŒè¯éƒ¨ç½²çŠ¶æ€
kubectl get pods -n kube-system -l app=rescheduler-scheduler

# 3. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨
kubectl logs -n kube-system -l app=rescheduler-scheduler --tail=20
```

**é¢„æœŸæ—¥å¿—è¾“å‡º**ï¼š
```
I0829 03:13:40.048948 1 rescheduler.go:112] "é‡è°ƒåº¦å™¨æ’ä»¶æ­£åœ¨åˆå§‹åŒ–"
I0829 03:13:40.049267 1 rescheduler.go:159] "é‡è°ƒåº¦å™¨å¼€å§‹è¿è¡Œ" interval="30s"
```

### ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²æµ‹è¯•Pod
```bash
# 1. éƒ¨ç½²è´Ÿè½½æµ‹è¯•
kubectl apply -f manifests/rescheduler/test-pods.yaml

# 2. æŸ¥çœ‹åˆå§‹Podåˆ†å¸ƒ
kubectl get pods --all-namespaces -o wide | awk '{print $8}' | sort | uniq -c
```

### ç¬¬å››æ­¥ï¼šè§‚å¯Ÿé‡è°ƒåº¦è¿‡ç¨‹
```bash
# 1. å®æ—¶ç›‘æ§é‡è°ƒåº¦æ—¥å¿—
kubectl logs -n kube-system -l app=rescheduler-scheduler -f

# 2. ç›‘æ§Podåˆ†å¸ƒå˜åŒ–
watch "kubectl get pods --all-namespaces -o wide | awk '{print \$8}' | sort | uniq -c"
```

**é¢„æœŸé‡è°ƒåº¦æ—¥å¿—**ï¼š
```
I0829 03:14:10.050254 1 rescheduler.go:170] "å¼€å§‹æ‰§è¡Œé‡è°ƒåº¦æ£€æŸ¥"
I0829 03:14:10.050856 1 controller.go:252] "å¼€å§‹æ‰§è¡ŒPodè¿ç§»" 
  strategy="LoadBalancing" sourceNode="worker1" targetNode="worker2"
I0829 03:14:10.087521 1 controller.go:372] "æˆåŠŸåˆ›å»ºç›®æ ‡Pod"
I0829 03:14:10.113996 1 rescheduler.go:219] "å®Œæˆé‡è°ƒåº¦æ“ä½œ" é‡è°ƒåº¦Podæ•°é‡=2
```

## âš™ï¸ é…ç½®å‚æ•°

### é‡è°ƒåº¦å™¨é…ç½® (manifests/rescheduler/deployment.yaml)
```yaml
pluginConfig:
- name: Rescheduler
  args:
    reschedulingInterval: "30s"     # é‡è°ƒåº¦æ£€æŸ¥é—´éš”
    enabledStrategies:              # å¯ç”¨çš„ç­–ç•¥
      - "LoadBalancing"
      - "ResourceOptimization"
      - "NodeMaintenance"
    cpuThreshold: 80.0             # CPUä½¿ç”¨ç‡é˜ˆå€¼(%)
    memoryThreshold: 80.0          # å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼(%)
    imbalanceThreshold: 20.0       # è´Ÿè½½ä¸å‡è¡¡é˜ˆå€¼(%)
    maxReschedulePods: 10          # å•æ¬¡æœ€å¤§é‡è°ƒåº¦Podæ•°
    excludedNamespaces:            # æ’é™¤çš„å‘½åç©ºé—´
      - "kube-system"
      - "kube-public"
```

### æµ‹è¯•åœºæ™¯é…ç½®
```yaml
# 1. è´Ÿè½½å‡è¡¡æµ‹è¯• - å¼ºåˆ¶æ‰€æœ‰Podåˆ°ä¸€ä¸ªèŠ‚ç‚¹
nodeSelector:
  kubernetes.io/hostname: worker-node-1

# 2. èµ„æºå‹åŠ›æµ‹è¯• - é«˜èµ„æºè¯·æ±‚
resources:
  requests:
    cpu: 200m
    memory: 256Mi

# 3. èŠ‚ç‚¹ç»´æŠ¤æµ‹è¯•
kubectl label node worker-1 scheduler.alpha.kubernetes.io/maintenance=true
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šè´Ÿè½½å‡è¡¡æµ‹è¯•
```bash
# åˆ›å»ºä¸å‡è¡¡è´Ÿè½½
kubectl create deployment heavy-load --image=nginx --replicas=20
kubectl patch deployment heavy-load -p '{"spec":{"template":{"spec":{"nodeSelector":{"kubernetes.io/hostname":"worker-1"}}}}}'

# ç­‰å¾…é‡è°ƒåº¦å™¨è‡ªåŠ¨å¹³è¡¡ (30ç§’å‘¨æœŸ)
# è§‚å¯ŸPodé‡æ–°åˆ†å¸ƒåˆ°å…¶ä»–èŠ‚ç‚¹
```

### åœºæ™¯2ï¼šèŠ‚ç‚¹ç»´æŠ¤æµ‹è¯•
```bash
# æ ‡è®°èŠ‚ç‚¹è¿›å…¥ç»´æŠ¤æ¨¡å¼
kubectl label node worker-1 scheduler.alpha.kubernetes.io/maintenance=true

# è§‚å¯Ÿè¯¥èŠ‚ç‚¹ä¸Šçš„Podè¢«è‡ªåŠ¨è¿ç§»
kubectl get pods -o wide --field-selector spec.nodeName=worker-1

# é€€å‡ºç»´æŠ¤æ¨¡å¼
kubectl label node worker-1 scheduler.alpha.kubernetes.io/maintenance-
```

### åœºæ™¯3ï¼šèµ„æºä¼˜åŒ–æµ‹è¯•
```bash
# åˆ›å»ºé«˜CPUä½¿ç”¨çš„Pod
kubectl run cpu-hog --image=progrium/stress --restart=Never -- --cpu 2
kubectl label pod cpu-hog scheduler.alpha.kubernetes.io/rescheduling=enabled

# è§‚å¯Ÿé‡è°ƒåº¦å™¨åŸºäºèµ„æºä½¿ç”¨ç‡è¿›è¡Œä¼˜åŒ–
```

## ğŸ“Š ç›‘æ§å’Œæ•…éšœæ’æŸ¥

### é‡è¦ç›‘æ§æŒ‡æ ‡
```bash
# 1. é‡è°ƒåº¦å™¨çŠ¶æ€
kubectl get pods -n kube-system -l app=rescheduler-scheduler

# 2. é‡è°ƒåº¦æ“ä½œç»Ÿè®¡
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep "å®Œæˆé‡è°ƒåº¦æ“ä½œ"

# 3. èŠ‚ç‚¹èµ„æºä½¿ç”¨
kubectl top nodes

# 4. Podåˆ†å¸ƒç»Ÿè®¡
kubectl get pods --all-namespaces -o wide | awk '{print $8}' | sort | uniq -c
```

### å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1: é‡è°ƒåº¦å™¨Podæ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
docker images | grep scheduler-plugins

# æ£€æŸ¥æƒé™é…ç½®
kubectl describe pod -n kube-system -l app=rescheduler-scheduler

# è§£å†³æ–¹æ¡ˆ: ç¡®ä¿é•œåƒå·²åŠ è½½åˆ°é›†ç¾¤èŠ‚ç‚¹
kind load docker-image scheduler-plugins:latest --name your-cluster
```

**é—®é¢˜2: æ²¡æœ‰é‡è°ƒåº¦æ´»åŠ¨**
```bash
# æ£€æŸ¥æ’ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep "é‡è°ƒåº¦å™¨æ’ä»¶æ­£åœ¨åˆå§‹åŒ–"

# æ£€æŸ¥è´Ÿè½½æ˜¯å¦æ»¡è¶³é‡è°ƒåº¦æ¡ä»¶
kubectl get pods -o wide | awk '{print $7}' | sort | uniq -c

# è§£å†³æ–¹æ¡ˆ: åˆ›å»ºæ›´æ˜æ˜¾çš„è´Ÿè½½ä¸å‡è¡¡æµ‹è¯•åœºæ™¯
```

**é—®é¢˜3: Podè¿ç§»å¤±è´¥**
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
kubectl logs -n kube-system -l app=rescheduler-scheduler | grep -E "(å¤±è´¥|Error)"

# å¸¸è§åŸå› : Podæœ‰nodeSelectorçº¦æŸ
kubectl get pod <pod-name> -o yaml | grep -A5 nodeSelector

# è§£å†³æ–¹æ¡ˆ: ç§»é™¤çº¦æŸæˆ–é…ç½®æ’é™¤æ ‡ç­¾
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰ç­–ç•¥æƒé‡
```yaml
# åœ¨ä»£ç ä¸­è°ƒæ•´ç­–ç•¥ä¼˜å…ˆçº§
const (
    LoadBalancingWeight        = 100
    ResourceOptimizationWeight = 80
    NodeMaintenanceWeight      = 120
)
```

### æ‰©å±•æ–°çš„é‡è°ƒåº¦ç­–ç•¥
```go
// æ·»åŠ æ–°ç­–ç•¥åˆ° enabledStrategies
const CustomStrategy = "CustomStrategy"

// åœ¨é‡è°ƒåº¦é€»è¾‘ä¸­å®ç°æ–°ç­–ç•¥
func (r *Rescheduler) evaluateCustomStrategy(nodes []*NodeResourceUsage) []*ReschedulingDecision {
    // è‡ªå®šä¹‰é‡è°ƒåº¦é€»è¾‘
}
```

## ğŸ“ é¡¹ç›®ç»“æ„
```
scheduler-plugins/
â”œâ”€â”€ pkg/rescheduler/           # é‡è°ƒåº¦å™¨æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ rescheduler.go         # ä¸»è¦æ’ä»¶é€»è¾‘
â”‚   â”œâ”€â”€ controller.go          # è¿ç§»æ§åˆ¶å™¨
â”‚   â””â”€â”€ README.md              # è¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ manifests/rescheduler/     # éƒ¨ç½²é…ç½®
â”‚   â”œâ”€â”€ deployment.yaml        # å®Œæ•´éƒ¨ç½²é…ç½®
â”‚   â””â”€â”€ test-pods.yaml         # æµ‹è¯•Podé…ç½®
â”œâ”€â”€ cmd/scheduler/             # è°ƒåº¦å™¨å…¥å£
â””â”€â”€ Dockerfile.local           # é•œåƒæ„å»ºæ–‡ä»¶
```

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®

1. **èµ„æºé…ç½®**: æ ¹æ®é›†ç¾¤è§„æ¨¡è°ƒæ•´è°ƒåº¦å™¨Podçš„èµ„æºè¯·æ±‚
2. **ç›‘æ§é›†æˆ**: é…ç½®PrometheusæŒ‡æ ‡æ”¶é›†
3. **é«˜å¯ç”¨**: å¯ç”¨leaderé€‰ä¸¾ï¼Œéƒ¨ç½²å¤šå‰¯æœ¬
4. **å®‰å…¨é…ç½®**: ä½¿ç”¨æœ€å°æƒé™åŸåˆ™é…ç½®RBAC
5. **æ—¥å¿—ç®¡ç†**: é…ç½®æ—¥å¿—è½®è½¬å’Œé›†ä¸­æ”¶é›†

## ğŸ“ æ”¯æŒå’Œè´¡çŒ®

- ğŸ› BugæŠ¥å‘Š: æäº¤Issueæè¿°é—®é¢˜å’Œé‡ç°æ­¥éª¤
- ğŸ’¡ åŠŸèƒ½å»ºè®®: åœ¨Issueä¸­æå‡ºæ–°åŠŸèƒ½æƒ³æ³•
- ğŸ”§ ä»£ç è´¡çŒ®: Forké¡¹ç›®å¹¶æäº¤Pull Request
- ğŸ“– æ–‡æ¡£æ”¹è¿›: å¸®åŠ©å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

---

**æ­å–œï¼æ‚¨å·²æˆåŠŸéƒ¨ç½²å¹¶æµ‹è¯•äº†è‡ªå®šä¹‰çš„Kubernetesé‡è°ƒåº¦å™¨æ’ä»¶ï¼** ğŸ‰
