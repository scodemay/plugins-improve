# Scheduler-Plugins 监控系统完整部署手册

## 📋 概述

本手册提供了 Scheduler-Plugins 项目监控系统的完整部署指南，包括从零开始的环境准备、分步部署、配置优化和故障排除。

## 🎯 监控系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    完整监控系统架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │
│  │   Grafana   │    │ Prometheus  │    │   指标收集器集群      │  │
│  │  可视化面板  │◄───┤  时序数据库  │◄───┤                    │  │
│  │  :3000      │    │   :9090     │    │ • 原版收集器 :8080   │  │
│  └─────────────┘    └─────────────┘    │ • 增强收集器 :8081   │  │
│                                        │ • Go导出器 :8082    │  │
│                                        └─────────────────────┘  │
│                                               │                │
│                                               ▼                │
│                                        ┌─────────────┐         │
│                                        │ Kubernetes  │         │
│                                        │  API Server │         │
│                                        │ (集群数据源) │         │
│                                        └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## 🚀 快速部署 (推荐)

### 方法1: 使用一键部署脚本

```bash
# 进入项目目录
cd /home/chenyu/Desktop/scheduler-plugins

# 运行快速启动菜单
./quick-start.sh

# 选择选项 1: 部署监控系统
# 这将自动执行: ./tools/monitoring/deploy-enhanced-monitoring.sh
```

### 方法2: 直接运行部署脚本

```bash
# 部署增强监控系统
./tools/monitoring/deploy-enhanced-monitoring.sh
```

## 📁 完整部署 (手动部署)

### 第一步: 环境准备

#### 1.1 检查依赖
```bash
# 检查kubectl
kubectl version --client

# 检查集群连接
kubectl cluster-info

# 检查集群节点
kubectl get nodes
```

#### 1.2 创建命名空间
```bash
# 创建monitoring命名空间
kubectl create namespace monitoring
```

### 第二步: 部署核心组件

#### 2.1 部署Prometheus
```bash
# 使用完整的Prometheus配置
kubectl apply -f monitoring/deployments/prometheus-deployment.yaml

# 验证部署
kubectl get pods -n monitoring -l app=prometheus
kubectl get svc -n monitoring -l app=prometheus
```

#### 2.2 部署Grafana
```bash
# 使用完整的Grafana配置
kubectl apply -f monitoring/deployments/grafana-deployment.yaml

# 验证部署
kubectl get pods -n monitoring -l app=grafana
kubectl get svc -n monitoring -l app=grafana
```

#### 2.3 部署指标收集器
```bash
# 部署增强版指标收集器
kubectl apply -f monitoring/deployments/enhanced-metrics-collector.yaml

# 验证部署
kubectl get pods -n monitoring -l app=enhanced-metrics-collector
kubectl get svc -n monitoring -l app=enhanced-metrics-collector
```

### 第三步: 验证部署

#### 3.1 检查所有组件状态
```bash
# 查看所有Pod状态
kubectl get pods -n monitoring

# 预期输出 (所有Pod应为Running状态):
# NAME                                         READY   STATUS    
# enhanced-metrics-collector-xxx               1/1     Running   
# grafana-xxx                                  1/1     Running   
# prometheus-xxx                               1/1     Running   
```

#### 3.2 检查服务状态
```bash
# 查看所有服务
kubectl get svc -n monitoring

# 预期输出:
# NAME                                   TYPE        CLUSTER-IP      PORT(S)          
# enhanced-rescheduler-metrics-service   ClusterIP   10.96.164.52    8080/TCP         
# grafana-service                        NodePort    10.96.155.142   3000:30300/TCP   
# prometheus-service                     NodePort    10.96.72.26     9090:30090/TCP   
```

### 第四步: 配置访问

#### 4.1 建立端口转发
```bash
# Grafana访问 (推荐)
kubectl port-forward -n monitoring svc/grafana-service 3000:3000 &

# Prometheus访问
kubectl port-forward -n monitoring svc/prometheus-service 9090:9090 &

# 增强指标收集器访问
kubectl port-forward -n monitoring svc/enhanced-rescheduler-metrics-service 8081:8080 &
```

#### 4.2 或使用访问脚本
```bash
# 运行访问脚本 (会自动设置端口转发)
./tools/monitoring/access-monitoring.sh
```

### 第五步: 配置Grafana仪表板

#### 5.1 登录Grafana
- **地址**: http://localhost:3000
- **用户名**: admin
- **密码**: admin123

#### 5.2 添加数据源
1. 进入 Configuration → Data Sources
2. 添加 Prometheus 数据源
3. 设置URL: `http://prometheus-service:9090`
4. 点击 "Save & Test"

#### 5.3 导入仪表板
```bash
# 方法1: 使用增强版仪表板 (推荐)
# 在Grafana中导入: monitoring/configs/enhanced-dashboard.json

```

## 📊 部署配置文件详解

### 核心配置文件列表

| 配置文件 | 作用 | 类型 |
|---------|------|------|
| `monitoring/deployments/prometheus-deployment.yaml` | Prometheus完整部署 | 必需 |
| `monitoring/deployments/grafana-deployment.yaml` | Grafana完整部署 | 必需 |
| `monitoring/deployments/enhanced-metrics-collector.yaml` | 增强指标收集器 | 必需 |
| `monitoring/configs/enhanced-dashboard.json` | 增强版Grafana面板 | 推荐 |


### 配置文件组成

#### Prometheus部署文件包含:
- ✅ ConfigMap (prometheus.yml配置)
- ✅ Deployment (应用部署)
- ✅ Service (NodePort服务)
- ✅ ServiceAccount (服务账户)
- ✅ ClusterRole (集群角色)
- ✅ ClusterRoleBinding (角色绑定)

#### Grafana部署文件包含:
- ✅ ConfigMap (grafana.ini配置)
- ✅ Deployment (应用部署)
- ✅ Service (NodePort服务)

#### 指标收集器文件包含:
- ✅ ConfigMap (收集脚本)
- ✅ Deployment (应用部署)
- ✅ Service (ClusterIP服务)

## 🔧 部署脚本说明

### 自动化脚本列表

| 脚本文件 | 功能 | 使用场景 |
|---------|------|----------|
| `quick-start.sh` | 快速启动菜单 | 项目入口 |
| `tools/monitoring/deploy-enhanced-monitoring.sh` | 部署增强监控 | 自动化部署 |
| `tools/monitoring/access-monitoring.sh` | 配置访问 | 访问设置 |
| `tools/monitoring/test-separated-metrics.sh` | 测试指标 | 功能验证 |

### 脚本功能详解

#### `deploy-enhanced-monitoring.sh`
```bash
# 功能:
# 1. 检查依赖 (kubectl, 集群连接)
# 2. 创建monitoring命名空间
# 3. 部署增强指标收集器
# 4. 配置Prometheus抓取
# 5. 验证部署状态
# 6. 生成访问信息
# 7. 配置Grafana可视化面板
```

#### `access-monitoring.sh`
```bash
# 功能:
# 1. 检查服务状态
# 2. 自动设置端口转发
# 3. 显示访问地址和登录信息
# 4. 测试指标端点
# 5. 提供故障排除建议
```
####如需Go导出器
```bash
# 需要创建部署配置
kubectl create deployment rescheduler-exporter \
  --image=your-registry/rescheduler-metrics-exporter:latest \
  -n monitoring

# 暴露服务
kubectl expose deployment rescheduler-exporter \
  --port=8080 --target-port=8080 \
  --name=rescheduler-exporter-service \
  -n monitoring
```

## 🎯 监控指标说明

### 核心监控指标

#### 1. Pod分布指标
```prometheus
# 基础Pod计数 (原版)
rescheduler_node_pods_count{node_name="worker1"} 33

# 增强Pod计数 (带标签)
rescheduler_node_pods_count{node_name="worker1",node_type="worker",role="worker"} 38
```

#### 2. 汇总统计指标
```prometheus
# Worker节点统计
rescheduler_worker_nodes_total 3           # Worker节点总数
rescheduler_worker_pods_total 116          # Worker节点Pod总数
rescheduler_worker_pods_avg 38.67         # Worker节点平均Pod数

# Control-plane统计
rescheduler_control_plane_pods_total 10    # Control-plane Pod总数
```

### 关键PromQL查询

#### 负载均衡分析
```promql
# 全局负载均衡率
(1 - (stddev(rescheduler_node_pods_count) / avg(rescheduler_node_pods_count))) * 100

# Worker节点负载均衡率 (推荐)
(1 - (stddev(rescheduler_node_pods_count{node_type="worker"}) / avg(rescheduler_node_pods_count{node_type="worker"}))) * 100

# Worker节点Pod分布方差
stddev(rescheduler_node_pods_count{node_type="worker"})
```

## 🔍 故障排除

### 常见问题解决

#### 1. Pod无法启动
```bash
# 检查Pod状态
kubectl describe pod -n monitoring <pod-name>

# 查看Pod日志
kubectl logs -n monitoring <pod-name>

# 检查资源限制
kubectl top pods -n monitoring
```

#### 2. 端口转发失败
```bash
# 杀死现有端口转发进程
pkill -f "kubectl port-forward"

# 重新建立端口转发
kubectl port-forward -n monitoring svc/grafana-service 3000:3000 &
kubectl port-forward -n monitoring svc/prometheus-service 9090:9090 &
```

#### 3. Grafana无数据显示
```bash
# 检查数据源配置
# 确保URL为: http://prometheus-service:9090

# 测试Prometheus连接
curl http://localhost:9090/api/v1/query?query=up

# 检查指标是否存在
curl http://localhost:9090/api/v1/label/__name__/values | grep rescheduler
```

#### 4. 指标收集器无数据
```bash
# 检查收集器状态
kubectl logs -n monitoring -l app=enhanced-metrics-collector

# 测试指标端点
curl http://localhost:8081/metrics

# 检查服务账户权限
kubectl auth can-i get pods --as=system:serviceaccount:monitoring:metrics-collector
```

## 🛠️ 高级配置

### 资源优化

#### 1. 调整资源限制
```yaml
# 编辑 prometheus-deployment.yaml
resources:
  requests:
    memory: "1Gi"      # 增加内存请求
    cpu: "200m"        # 增加CPU请求
  limits:
    memory: "2Gi"      # 增加内存限制
    cpu: "1000m"       # 增加CPU限制
```

#### 2. 数据保留策略
```yaml
# Prometheus参数优化
args:
- "--storage.tsdb.retention.time=60d"  # 保留60天数据
- "--storage.tsdb.retention.size=10GB" # 最大存储10GB
```

### 扩展功能

#### 1. 添加告警
```yaml
# 在prometheus.yml中添加告警规则
rule_files:
- "/etc/prometheus/alerts/*.yml"
```

#### 2. 集成外部存储
```yaml
# 配置远程写入
remote_write:
- url: "http://remote-storage:9201/write"
```

## 📈 性能测试

### 运行性能测试
```bash
# 方法1: 使用快速启动菜单
./quick-start.sh
# 选择选项 4: 运行性能测试

# 方法2: 直接运行测试
./scripts/run-performance-tests.sh

# 方法3: 监控性能数据
./scripts/monitor-performance.sh 30  # 监控30分钟
```

### 测试指标验证
```bash
# 测试分离指标功能
./tools/monitoring/test-separated-metrics.sh
```

## 📚 相关文档

### 项目文档
- 📄 `监控功能详细说明文档.md` - 详细功能说明
- 📄 `项目脚本分析报告.md` - 脚本分析报告
- 📄 `PROJECT_STRUCTURE.md` - 项目结构说明

### 配置文件
- 📄 `monitoring/deployments/` - 所有部署配置
- 📄 `monitoring/configs/` - Grafana仪表板配置
- 📄 `tools/monitoring/` - 监控工具脚本

## 🎯 部署检查清单

### 部署前检查
- [ ] Kubernetes集群可访问
- [ ] kubectl命令可用
- [ ] 集群有足够资源 (至少2GB内存, 1CPU)
- [ ] 有集群管理员权限

### 部署中检查  
- [ ] monitoring命名空间已创建
- [ ] Prometheus Pod运行正常
- [ ] Grafana Pod运行正常
- [ ] 指标收集器Pod运行正常
- [ ] 所有服务可访问

### 部署后验证
- [ ] 端口转发正常工作
- [ ] Grafana可登录 (admin/admin123)
- [ ] Prometheus有数据
- [ ] Grafana仪表板显示数据
- [ ] 指标端点返回数据

## 🚀 总结

通过本手册，您可以：

✅ **快速部署** - 使用一键脚本5分钟内完成部署  
✅ **完整监控** - 涵盖Pod分布、负载均衡、性能指标  
✅ **可视化展示** - 丰富的Grafana仪表板  
✅ **故障排除** - 详细的问题解决方案  
✅ **性能优化** - 资源配置和扩展建议  

监控系统部署完成后，您将拥有一个完整的Kubernetes调度器性能监控解决方案！

---
📞 **技术支持**: 如遇问题，请查看日志文件或运行故障排除脚本进行诊断。
