# ç®€åŒ–çš„æ„å»ºå’Œéƒ¨ç½² Makefile

.PHONY: all build build-image deploy test clean

# é»˜è®¤ç›®æ ‡
all: build build-image deploy

# æ„å»ºè°ƒåº¦å™¨äºŒè¿›åˆ¶
build:
	@echo "ğŸ“¦ æ„å»ºè°ƒåº¦å™¨äºŒè¿›åˆ¶æ–‡ä»¶..."
	make build-scheduler

# æ„å»ºDockeré•œåƒ
build-image:
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	docker build -f Dockerfile.local -t scheduler-plugins:latest .

# åŠ è½½é•œåƒåˆ°Kindé›†ç¾¤ (å¦‚æœä½¿ç”¨Kind)
load-image:
	@echo "ğŸ“¥ åŠ è½½é•œåƒåˆ°Kindé›†ç¾¤..."
	@if command -v kind >/dev/null 2>&1; then \
		kind load docker-image scheduler-plugins:latest || echo "âš ï¸  è¯·ç¡®è®¤Kindé›†ç¾¤åç§°"; \
	else \
		echo "â„¹ï¸  è·³è¿‡Kindé•œåƒåŠ è½½ (æœªæ£€æµ‹åˆ°Kind)"; \
	fi

# éƒ¨ç½²é‡è°ƒåº¦å™¨
deploy:
	@echo "ğŸš€ éƒ¨ç½²é‡è°ƒåº¦å™¨åˆ°Kubernetes..."
	kubectl apply -f manifests/rescheduler/deployment.yaml

# å¿«é€Ÿæµ‹è¯•
test:
	@echo "ğŸ§ª éƒ¨ç½²æµ‹è¯•Pod..."
	kubectl apply -f manifests/rescheduler/quick-test.yaml
	@echo ""
	@echo "ğŸ“Š æŸ¥çœ‹åˆå§‹Podåˆ†å¸ƒ:"
	kubectl get pods --all-namespaces -o wide | awk '{print $$8}' | sort | uniq -c
	@echo ""
	@echo "ğŸ‘€ ç›‘æ§é‡è°ƒåº¦æ—¥å¿—:"
	@echo "kubectl logs -n kube-system -l app=rescheduler-scheduler -f"

# æŸ¥çœ‹çŠ¶æ€
status:
	@echo "ğŸ“ˆ é‡è°ƒåº¦å™¨çŠ¶æ€:"
	kubectl get pods -n kube-system -l app=rescheduler-scheduler
	@echo ""
	@echo "ğŸ“Š å½“å‰Podåˆ†å¸ƒ:"
	kubectl get pods --all-namespaces -o wide | awk '{print $$8}' | sort | uniq -c

# æ¸…ç†æµ‹è¯•èµ„æº
clean-test:
	@echo "ğŸ§¹ æ¸…ç†æµ‹è¯•èµ„æº..."
	kubectl delete deployment load-imbalance-test --ignore-not-found
	kubectl delete pod resource-heavy-pod --ignore-not-found
	kubectl delete configmap test-commands --ignore-not-found

# å®Œå…¨æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†é‡è°ƒåº¦å™¨å’Œæµ‹è¯•èµ„æº..."
	kubectl delete -f manifests/rescheduler/deployment.yaml --ignore-not-found
	kubectl delete -f manifests/rescheduler/quick-test.yaml --ignore-not-found
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ˜¾ç¤ºæœ‰ç”¨çš„å‘½ä»¤
help:
	@echo "ğŸš€ é‡è°ƒåº¦å™¨é¡¹ç›® - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "æ„å»ºå’Œéƒ¨ç½²:"
	@echo "  make build        - æ„å»ºè°ƒåº¦å™¨äºŒè¿›åˆ¶"
	@echo "  make build-image  - æ„å»ºDockeré•œåƒ"  
	@echo "  make load-image   - åŠ è½½é•œåƒåˆ°Kindé›†ç¾¤"
	@echo "  make deploy       - éƒ¨ç½²é‡è°ƒåº¦å™¨"
	@echo ""
	@echo "æµ‹è¯•å’Œç›‘æ§:"
	@echo "  make test         - éƒ¨ç½²æµ‹è¯•Pod"
	@echo "  make status       - æŸ¥çœ‹çŠ¶æ€"
	@echo ""
	@echo "æ¸…ç†:"
	@echo "  make clean-test   - æ¸…ç†æµ‹è¯•èµ„æº"
	@echo "  make clean        - å®Œå…¨æ¸…ç†"
	@echo ""
	@echo "ä¸€é”®æ“ä½œ:"
	@echo "  make all          - æ„å»º+é•œåƒ+éƒ¨ç½²"
